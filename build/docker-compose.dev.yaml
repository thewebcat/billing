version: '3.6'

x-global-environment: &global-environment
  C_PROJECT_STACK: __C_PROJECT_STACK__
  C_PROJECT_NAME: __C_PROJECT_NAME__

x-global: &global
  environment:
    <<: *global-environment
  env_file:
    - .env
  restart: unless-stopped

volumes:
  pgdata:


services:

  db:
    <<: *global
    image: "postgres:latest"
    container_name: __C_PROJECT_NAME__-db
    environment:
      - POSTGRES_DB=billing
      - POSTGRES_PASSWORD=secret
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./share/sql:/docker-entrypoint-initdb.d/
    ports:
      - 5432:5432

  backend:
    <<: *global
    container_name: __C_PROJECT_NAME__-backend
    image: "__C_PROJECT_NAME__-virtualenv:latest"
    environment:
      - PYTHONPATH=$PWD:$PYTHONPATH
#    command: ["gunicorn", "billing.__main__:app", "-b", "0.0.0.0:8000", "--name", "billing", "--reload"]
    command: ["python", "-m", "billing"]
    volumes:
      - .:/code
    ports:
      - 8000:8000

  test:
    <<: *global
    image: "__C_PROJECT_NAME__-virtualenv-test:latest"
    volumes:
      - .:/code
    command: ["echo", "tests"]
    restart: "no"